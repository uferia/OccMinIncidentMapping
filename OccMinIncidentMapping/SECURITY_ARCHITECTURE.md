# Security Architecture Diagram

## Authentication Flow

```
???????????????
?   Client    ?
?  (Angular)  ?
???????????????
       ?
       ? 1. POST /api/auth/login
       ?    { username, password }
       ?
????????????????????????????????????????
?    AspNetCore Web API                ?
?  ??????????????????????????????????? ?
?  ?  AuthController.Login()         ? ?
?  ??????????????????????????????????? ?
?                 ?                    ?
?  ??????????????????????????????????? ?
?  ? ValidationBehavior              ? ?
?  ? (FluentValidation)              ? ?
?  ??????????????????????????????????? ?
?                 ?                    ?
?  ??????????????????????????????????? ?
?  ? LoginCommandHandler             ? ?
?  ?  - Validates credentials        ? ?
?  ?  - Generates JWT token          ? ?
?  ??????????????????????????????????? ?
?                 ?                    ?
?  ??????????????????????????????????? ?
?  ? JwtAuthenticationService        ? ?
?  ?  - Sign token with secret key   ? ?
?  ?  - Add claims (user, role)      ? ?
?  ?  - Set expiration               ? ?
?  ??????????????????????????????????? ?
?                 ?                    ?
????????????????????????????????????????
       ?          ?
       ?          ? 2. Response: { token, username, role }
       ?          ?
       ????????????????????????????????
              (Client stores JWT)

```

## Protected Endpoint Flow

```
????????????????????????????
?   Client (Angular)       ?
?  Stored JWT Token        ?
????????????????????????????
               ?
       GET /api/incidents
       Authorization: Bearer {JWT}
               ?
               ?
????????????????????????????????????????????????
?   AspNetCore Web API - Request Pipeline      ?
????????????????????????????????????????????????
?                                              ?
?  1. SecurityHeadersMiddleware                ?
?     ? Adds security headers                  ?
?                                              ?
?  2. ExceptionMiddleware                      ?
?     ? Catches exceptions                     ?
?                                              ?
?  3. AuditLoggingMiddleware                   ?
?     ? Logs request                           ?
?                                              ?
?  4. CORS Middleware                          ?
?     ? Validates origin                       ?
?                                              ?
?  5. Authentication Middleware                ?
?     ? Validates JWT signature                ?
?     ? Extracts claims (user, role)           ?
?                                              ?
?  6. Authorization Middleware                 ?
?     ? Checks [Authorize] attribute           ?
?     ? Validates user role (if needed)        ?
?                                              ?
?  7. IncidentsController.Get()                ?
?     ? Retrieves incidents from Firebase      ?
?                                              ?
?  8. Response sent back                       ?
?     ? AuditLoggingMiddleware logs response   ?
?                                              ?
????????????????????????????????????????????????
               ?
               ?
        ????????????????????
        ? Response: 200 OK ?
        ? + Incidents data ?
        ? + Security hdrs   ?
        ????????????????????

```

## Middleware Processing Order

```
Request
  ?
[SecurityHeadersMiddleware]
  ? Adds: X-Frame-Options, X-Content-Type-Options, CSP, etc.
  ?
[ExceptionMiddleware]
  ? Wraps request processing with try-catch
  ?
[AuditLoggingMiddleware]
  ? Logs: Username, HTTP method, path, timestamp
  ?
[CORS Middleware]
  ? Validates origin, allows credentials
  ?
[Authentication Middleware] (JWT)
  ? Validates token, extracts claims
  ?
[Authorization Middleware]
  ? Checks [Authorize] attributes
  ?
[Endpoint]
  ? Controller action executes
  ?
Response
  ? (Middleware processes in reverse order)
  ?
[AuditLoggingMiddleware] - logs response status
  ?
Client receives response with security headers
```

## JWT Token Structure

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.
eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6ImFkbWluIiwicm9sZSI6IkFkbWluIn0.
TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ

???????????????????????????????????????
? Header (Base64URL encoded)          ?
? {                                   ?
?   "alg": "HS256",                   ?
?   "typ": "JWT"                      ?
? }                                   ?
???????????????????????????????????????
         ?
         ?
         ?????????
         ?
         ?
???????????????????????????????????????
? Payload (Base64URL encoded)         ?
? {                                   ?
?   "sub": "admin",                   ?
?   "name": "admin",                  ?
?   "role": "Admin",                  ?
?   "iat": 1234567890,                ?
?   "exp": 1234571490                 ?
? }                                   ?
???????????????????????????????????????
         ?
         ?
         ?????????
         ?
         ?
???????????????????????????????????????
? Signature (HMACSHA256)              ?
? HMACSHA256(header+payload, secret)  ?
?                                     ?
? Prevents tampering - server verifies?
???????????????????????????????????????
```

## Security Layers

```
??????????????????????????????????????????????????
?  Layer 1: Transport Security (HTTPS)           ?
?  • Encryption in transit                       ?
?  • Certificate validation                      ?
?  • Prevents man-in-the-middle attacks          ?
??????????????????????????????????????????????????
                    ?
??????????????????????????????????????????????????
?  Layer 2: Authentication (JWT)                 ?
?  • Token-based identity verification           ?
?  • Cryptographic signature validation          ?
?  • Token expiration                            ?
??????????????????????????????????????????????????
                    ?
??????????????????????????????????????????????????
?  Layer 3: Authorization ([Authorize])          ?
?  • Endpoint-level access control               ?
?  • Role-based authorization (ready)            ?
?  • Permission enforcement                      ?
??????????????????????????????????????????????????
                    ?
??????????????????????????????????????????????????
?  Layer 4: Input Validation (FluentValidation) ?
?  • Type validation                             ?
?  • Range validation (lat/long)                 ?
?  • Length constraints                          ?
??????????????????????????????????????????????????
                    ?
??????????????????????????????????????????????????
?  Layer 5: Application Logic (Business Rules)  ?
?  • Domain logic execution                      ?
?  • Database operations                         ?
?  • Audit logging                               ?
??????????????????????????????????????????????????
```

## Threat Mitigation

```
???????????????????????????????????????????
? Threat: Unauthorized Access             ?
???????????????????????????????????????????
? Mitigations:                            ?
? • JWT Authentication                    ?
? • [Authorize] attributes                ?
? • Token expiration (60 min)             ?
? • Signature validation                  ?
???????????????????????????????????????????

???????????????????????????????????????????
? Threat: Information Disclosure          ?
???????????????????????????????????????????
? Mitigations:                            ?
? • Environment-based error messages      ?
? • Security headers (CSP, X-Frame, etc)  ?
? • Swagger disabled in production        ?
? • No sensitive data in logs             ?
???????????????????????????????????????????

???????????????????????????????????????????
? Threat: CSRF/Clickjacking               ?
???????????????????????????????????????????
? Mitigations:                            ?
? • X-Frame-Options: DENY                 ?
? • SameSite cookie attributes (ready)    ?
? • Origin validation via CORS            ?
? • CSRF token support (ready)            ?
???????????????????????????????????????????

???????????????????????????????????????????
? Threat: XSS (Cross-Site Scripting)      ?
???????????????????????????????????????????
? Mitigations:                            ?
? • Content-Security-Policy header        ?
? • X-XSS-Protection header               ?
? • Input validation (server-side)        ?
? • Angular's built-in XSS protection     ?
???????????????????????????????????????????

???????????????????????????????????????????
? Threat: DoS/Buffer Overflow             ?
???????????????????????????????????????????
? Mitigations:                            ?
? • Request size limits (10 MB)           ?
? • Input length validation               ?
? • Rate limiting (future)                ?
? • Timeout configurations                ?
???????????????????????????????????????????

???????????????????????????????????????????
? Threat: Unauthorized Data Access        ?
???????????????????????????????????????????
? Mitigations:                            ?
? • Audit logging (all actions)           ?
? • User tracking (claims-based)          ?
? • Firebase security rules (config)      ?
? • Data encryption (future)              ?
???????????????????????????????????????????
```

## Config Environment Flow

```
????????????????????????
?  Environment         ?
?  Variable            ?
?  ASPNETCORE_ENV      ?
????????????????????????
       ?
       ?? Development
       ?  ?
       ?  appsettings.json
       ?  +
       ?  appsettings.Development.json
       ?  Result: Verbose logging, longer tokens
       ?
       ?? Staging
       ?  ?
       ?  appsettings.json
       ?  +
       ?  appsettings.Staging.json (optional)
       ?  Result: Moderate logging, production-like
       ?
       ?? Production
          ?
          appsettings.json
          +
          appsettings.Production.json
          +
          Environment variables (secrets)
          Result: Minimal logging, strict validation
```

This comprehensive diagram shows:
1. How authentication flows through the system
2. The middleware processing order
3. JWT token structure
4. Layered security approach
5. Threat mitigations
6. Environment-based configuration
